<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no"
    />
    <base target="_top" />
    <title>SPA Example</title>
    <link
      rel="stylesheet"
      href="style-member.css"
      id="style-member-select"
      disabled
    />
    <link
      rel="stylesheet"
      href="style-class.css"
      id="style-class-select"
      disabled
    />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4"></script>
    <script src="supabase.js"></script>

    <script type="module" src="https://sclass0614.github.io/authCheck/authCheck.js"></script>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        width: 100%;
        font-family: "Noto Sans KR", sans-serif;
        background: linear-gradient(
          135deg,
          var(--light-color) 0%,
          #ffffff 100%
        );
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0.625rem 1.25rem;
        animation: index-fadeIn 0.5s ease-in-out;
        opacity: 1;
      }

      #index-container {
        width: 100%;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      }

      #index-container.index-visible {
        opacity: 1;
      }

      .index-page-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }

      .index-page-loading.index-active {
        opacity: 1;
        visibility: visible;
      }

      .index-loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #3498db;
        border-radius: 50%;
        animation: index-spin 1s linear infinite;
      }

      @keyframes index-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <div class="index-page-loading">
      <div class="index-loading-spinner"></div>
    </div>

    <div id="index-container">페이지 로딩 중...</div>

    <script>
      function setActiveStyle(pageName) {
        const pages = ["member-select", "class-select"];
        pages.forEach((name) => {
          const link = document.getElementById(`style-${name}`);
          if (link) link.disabled = name !== pageName;
        });
      }

      window.appState = {
        selectedMember: null,
        selectedDate: new Date(),
        appliedClasses: [],
      };

      window.totalData = {
        memberData: null,
        classData: null,
        planData: null,
      };

      window.updateState = function (key, value) {
        if (!window.appState) {
          window.appState = {};
        }

        try {
          window.appState[key] = value;

          const event = new CustomEvent("stateChanged", {
            detail: { key, value },
          });
          window.dispatchEvent(event);
        } catch (error) {
          
        }
      };

      async function loadMemberData(formattedDate) {
        try {
          const result = await getselectedMemberData(formattedDate);
          return result;
        } catch (error) {
          
          throw error;
        }
      }

      async function loadClassData(formattedDate) {
        try {
          const result = await getselectedClassData(formattedDate);
          return result;
        } catch (error) {
          
          throw error;
        }
      }

      async function loadPlanData(formattedDate) {
        try {
          const result = await getselectedPlanData(formattedDate);
          return result;
        } catch (error) {
          
          throw error;
        }
      }

      async function loadAllData(formattedDate) {
        try {
          if (!formattedDate) {
            formattedDate = formatDate(new Date());
          } else {
            formattedDate = formatDate(formattedDate);
          }

          const loading = document.querySelector(".index-page-loading");
          if (loading) loading.classList.add("index-active");
          
          initSupabase();

          const [memberData, classData, planData] = await Promise.all([
            loadMemberData(formattedDate),
            loadClassData(formattedDate),
            loadPlanData(formattedDate),
          ]);

          window.totalData.memberData = memberData;
          window.totalData.classData = classData;
          window.totalData.planData = planData;

          if (loading) loading.classList.remove("index-active");

          return window.totalData;
        } catch (error) {
          
          const loading = document.querySelector(".index-page-loading");
          if (loading) loading.classList.remove("index-active");

          throw error;
        }
      }

      async function loadPage(pageName) {
        try {
          const loading = document.querySelector(".index-page-loading");
          const container = document.getElementById("index-container");

          loading.classList.add("index-active");
          container.classList.remove("index-visible");

          const pageResult = await fetch(`${pageName}.html`);
          const html = await pageResult.text();

          if (pageName === "class-select" || pageName === "member-select") {
            try {
              const selectedDate = window.appState?.selectedDate || new Date();
              const formattedDate = formatDate(selectedDate);

              await new Promise((resolve) => setTimeout(resolve, 250));
              await loadAllData(formattedDate);
            } catch (dataError) {
              
            }
          }

          setActiveStyle(pageName);

          setTimeout(() => {
            renderPage(html, pageName);
          }, 300);
        } catch (e) {
          
          document.getElementById("index-container").innerHTML =
            "<p>페이지를 불러올 수 없습니다.</p>";

          document
            .querySelector(".index-page-loading")
            .classList.remove("index-active");
        }
      }

      function renderPage(html, pageName) {
        const container = document.getElementById("index-container");
        const loading = document.querySelector(".index-page-loading");

        container.innerHTML = html;

        const oldScripts = document.querySelectorAll(
          "script[data-dynamic-script]"
        );
        oldScripts.forEach((script) => script.remove());

        const scripts = container.querySelectorAll("script");
        scripts.forEach((script) => {
          const newScript = document.createElement("script");
          newScript.textContent = `(function() { ${script.textContent} })();`;
          newScript.setAttribute("data-dynamic-script", "true");
          document.body.appendChild(newScript);
        });

        setTimeout(() => {
          if (
            pageName === "class-select" &&
            typeof window.initializeClassSelect === "function"
          ) {
            window.initializeClassSelect();
          } else if (
            pageName === "member-select" &&
            typeof window.initializeMemberSelect === "function"
          ) {
            window.initializeMemberSelect();
          }

          window.requestAnimationFrame(() => {
            loading.classList.remove("index-active");
            container.classList.add("index-visible");
          });
        }, 300);
      }

      document.addEventListener("DOMContentLoaded", async () => {
        if (!window.appState) {
          window.appState = {
            selectedMember: null,
            selectedDate: new Date(),
            appliedClasses: [],
          };
        }

        if (!window.totalData) {
          window.totalData = {
            memberData: null,
            classData: null,
            planData: null,
          };
        }

        initSupabase();

        const today = new Date();
        const formattedDate = formatDate(today);

        loadPage("member-select");
      });

      function formatDate(input) {
        if (input instanceof Date) {
          const year = input.getFullYear();
          const month = String(input.getMonth() + 1).padStart(2, "0");
          const day = String(input.getDate()).padStart(2, "0");
          return `${year}${month}${day}`;
        }

        if (typeof input === "string" && input.includes("-")) {
          return input.replace(/-/g, "");
        }

        return input;
      }
    </script>
  </body>
</html>